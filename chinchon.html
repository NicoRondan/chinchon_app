<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Tabla Puntajes Chinchón</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .fade-enter {
        opacity: 0;
        transform: scale(0.95);
        transition: all 0.3s;
      }
      .fade-enter-active {
        opacity: 1;
        transform: scale(1);
      }
      .animate-fadein {
        animation: fadein 0.7s cubic-bezier(0.22, 0.68, 0, 1.71);
      }
      @keyframes fadein {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .disabled-input {
        background: #e5e7eb !important;
        cursor: not-allowed !important;
      }
      .sticky-total {
        position: fixed !important;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 30;
        box-shadow: 0 -4px 16px #0001;
        width: 100vw;
        max-width: 700px;
        margin: 0 auto;
      }
      .sticky-ghost-row {
        height: 56px;
      }
      .enganchado {
        background: #fde68a !important;
        transition: background 0.5s;
      }
      .enganchado-flash {
        animation: enganche-flash 1s cubic-bezier(0.82, -0.04, 0.35, 1.12);
      }
      @keyframes enganche-flash {
        0% {
          background: #ffe066;
        }
        40% {
          background: #fff700;
        }
        75% {
          background: #fce588;
        }
        100% {
          background: #fde68a;
        }
      }
      .pozo-badge {
        font-size: 1.2rem;
      }
      .winner-badge {
        font-size: 1.25rem;
        background: #4ade80;
        color: #134e23;
        border-radius: 0.5rem;
        padding: 0.5rem 1.25rem;
        margin: 1.2rem 0;
      }
      .disabled-row {
        pointer-events: none;
        opacity: 0.65;
      }
      /* Sticky header para mobile */
      @media (max-width: 700px) {
        thead tr th {
          position: sticky;
          top: 0;
          z-index: 10;
          background: #2563eb;
          color: white;
        }
        .sticky-total {
          position: fixed !important;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 30;
          width: 100vw;
          max-width: 700px;
          margin: 0 auto;
          box-shadow: 0 -4px 16px #0001;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
    <h1
      class="text-2xl md:text-3xl font-bold text-blue-700 mb-3 text-center animate-fadein"
    >
      Tabla de Puntajes Chinchón
    </h1>
    <div id="notif" class="fixed top-3 z-50 left-1/2 -translate-x-1/2"></div>
    <div id="pozoTotal" class="mb-2 pozo-badge text-green-700 font-semibold">
      Pozo: $0
    </div>
    <div class="flex flex-wrap gap-2 mb-3 w-full justify-center">
      <button
        onclick="addPlayer()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition"
      >
        Añadir Jugador
      </button>
      <button
        onclick="resetScores()"
        class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded transition"
      >
        Reiniciar Puntajes
      </button>
    </div>
    <div id="winnerMsg" class="hidden"></div>
    <div class="overflow-x-auto w-full max-w-3xl mx-auto">
      <table class="min-w-max w-full border bg-white rounded shadow text-sm">
        <thead>
          <tr id="playerHeaders">
            <th class="px-2 py-2 bg-blue-600 text-white">Ronda</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
          <tr id="totalRow" class="font-bold bg-blue-50">
            <td class="px-2 py-2 text-blue-900">Total</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <script>
      // ======= STATE & STORAGE =======
      const LS_KEY = "chinchon_data_v3";
      let playerNames = ["Jugador 1", "Jugador 2"];
      let roundsArr = Array.from({ length: 10 }, () => []);
      let manualEnganches = [];
      let engancheAnimQueue = [];
      let isStickyTotal = false;
      let lastTotals = [];
      let gameOver = false;
      let winnerIndex = null;
      let enganches = []; // { idx, round, ref, total }

      const isManualEnganchado = (idx) =>
        manualEnganches.some((e) => e.idx === idx);

      function loadFromLS() {
        try {
          const data = JSON.parse(localStorage.getItem(LS_KEY));
          if (!data) return;
          playerNames = data.playerNames || playerNames;
          roundsArr = data.roundsArr || roundsArr;
          manualEnganches = data.manualEnganches || [];
          gameOver = data.gameOver || false;
          winnerIndex = data.winnerIndex ?? null;
          enganches = data.enganches || [];
        } catch (e) {}
      }
      function saveToLS() {
        localStorage.setItem(
          LS_KEY,
          JSON.stringify({
            playerNames,
            roundsArr,
            manualEnganches,
            enganches,
            gameOver,
            winnerIndex,
          })
        );
      }

      function showNotif(msg, color = "bg-green-600") {
        const notif = document.getElementById("notif");
        const div = document.createElement("div");
        div.className = `rounded shadow-lg ${color} text-white px-6 py-2 mb-2 animate-fadein flex items-center gap-2 text-base`;
        div.textContent = msg;
        notif.innerHTML = "";
        notif.appendChild(div);
        setTimeout(() => (notif.innerHTML = ""), 1100);
      }
      function escapeHtml(str) {
        return str.replace(/[&<>\"']/g, function (tag) {
          const chars = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          };
          return chars[tag] || tag;
        });
      }

      function getPlayerCount() {
        return playerNames.length;
      }

      function getTotals() {
        normalizeRoundsArr();
        return playerNames.map((_, i) => {
          // Enganches para este jugador, ordenados por ronda
          const engs = enganches
            .filter((e) => e.idx === i)
            .sort((a, b) => a.round - b.round);

          let sum = 0;
          let engPtr = 0;
          for (let r = 0; r < roundsArr.length; r++) {
            if (engPtr < engs.length && r === engs[engPtr].round) {
              const val = +roundsArr[r][i] || 0;
              sum = engs[engPtr].total + (isNaN(val) ? 0 : val);
              engPtr++;
            } else {
              let val = +roundsArr[r][i] || 0;
              sum += val;
            }
          }
          return sum;
        });
      }

      // Jugadores que pueden seguir: no superaron 100 y no están enganchados
      function getJugadoresVivos() {
        const totals = getTotals();
        return playerNames
          .map((_, i) => (totals[i] <= 100 ? i : null))
          .filter((i) => i !== null);
      }

      // ------ HEADER -----
      function renderHeader() {
        const headerRow = document.getElementById("playerHeaders");
        headerRow.innerHTML =
          '<th class="px-2 py-2 bg-blue-600 text-white">Ronda</th>';
        playerNames.forEach((name, i) => {
          headerRow.innerHTML += `
          <th class="bg-blue-600 text-white px-2 py-2 group whitespace-nowrap ${
            isManualEnganchado(i) ? "enganchado" : ""
          }">
            <div class="flex items-center gap-1 justify-center">
              <span class="editable cursor-pointer hover:underline" onclick="editPlayerName(${i})">${escapeHtml(
            name
          )}</span>
              <button onclick="removePlayer(${i})" title="Eliminar jugador" class="bg-red-100 hover:bg-red-300 text-red-700 rounded-full p-1 transition" style="font-size: 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M9.293 7.293a1 1 0 011.414 0L12 8.586l1.293-1.293a1 1 0 111.414 1.414L13.414 10l1.293 1.293a1 1 0 01-1.414 1.414L12 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L10.586 10l-1.293-1.293a1 1 0 010-1.414z"/></svg>
              </button>
            </div>
          </th>
        `;
        });
      }

      function shouldShowEnganchar(i) {
        if (gameOver || getPlayerCount() <= 2) return false;

        const totals = getTotals();
        if (totals[i] <= 100) return false; // no está pasado

        /* última ronda donde YA hay puntos para este jugador */
        let lastRound = -1;
        for (let r = roundsArr.length - 1; r >= 0; r--) {
          if (roundsArr[r][i] !== "" && roundsArr[r][i] !== undefined) {
            lastRound = r;
            break;
          }
        }
        if (lastRound === -1) return false; // nunca jugó

        /* ¿Hay algún puntaje cargado DESPUÉS de esa ronda?  */
        for (let r = lastRound + 1; r < roundsArr.length; r++) {
          if (roundsArr[r][i] !== "" && roundsArr[r][i] !== undefined) {
            return false; // ya empezó la ronda siguiente → demasiado tarde
          }
        }

        /* Pasó de 100 y todavía no escribió nada después: puede engancharse YA */
        return true;
      }

      function calcularPozo() {
        return playerNames.length * 500 + manualEnganches.length * 200;
      }

      function isPlayerDisabled(i) {
        const totals = getTotals();
        const enganchado = isManualEnganchado(i);

        if (gameOver) return true; // partida terminada

        /* 1.  Ya enganchado, y sigue arriba de 100 –– queda fuera hasta revivir */
        if (enganchado && totals[i] > 100) return true;

        const puedeEngancharAhora = shouldShowEnganchar(i);

        /* 2.  Si AÚN puede engancharse (botón visible) => NO se bloquea   */
        if (totals[i] > 100 && puedeEngancharAhora) return false;

        /* 3. Pasó los 100 y ya perdió la chance => se bloquea            */
        if (totals[i] > 100 && !puedeEngancharAhora) return true;

        return false; // resto de los casos
      }

      function normalizeRoundsArr() {
        for (let r = 0; r < roundsArr.length; r++) {
          for (let j = 0; j < getPlayerCount(); j++) {
            if (typeof roundsArr[r][j] === "undefined") {
              roundsArr[r][j] = "";
            }
          }
        }
      }

      function renderTable(focusNew = false, focusCol = 0) {
        normalizeRoundsArr();
        const tbody = document.getElementById("tableBody");
        let totals = getTotals();
        tbody.innerHTML = "";
        let isDisabled = gameOver;

        for (let i = 0; i < roundsArr.length; i++) {
          let tds = "";
          for (let j = 0; j < getPlayerCount(); j++) {
            const value = roundsArr[i][j] !== undefined ? roundsArr[i][j] : "";
            const disableInput = isPlayerDisabled(j);

            tds += `<td class="px-2 py-2">
        <input type="number" min="0"
          value="${value}"
          class="w-16 md:w-20 px-1 py-1 border rounded text-center bg-gray-50 focus:ring-2 focus:ring-blue-400 transition ${
            disableInput ? "disabled-input" : ""
          }"
          data-row="${i}" data-col="${j}"
          oninput="handleInput(${i},${j},this.value)"
          ${disableInput ? "disabled" : ""}
          onfocus="handleInputFocusBlur()" onblur="handleInputBlur()"
        >
      </td>`;
          }
          tbody.innerHTML += `
      <tr class="fade-enter ${isDisabled ? "disabled-row" : ""}">
        <td class="px-2 py-2 flex items-center justify-center gap-2">
          <span>${i + 1}</span>
          <button onclick="removeRound(${i})" title="Eliminar ronda" class="bg-red-100 hover:bg-red-300 text-red-700 rounded-full p-1 transition ml-2" style="font-size: 1rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M9.293 7.293a1 1 0 011.414 0L12 8.586l1.293-1.293a1 1 0 111.414 1.414L13.414 10l1.293 1.293a1 1 0 01-1.414 1.414L12 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L10.586 10l-1.293-1.293a1 1 0 010-1.414z"/></svg>
          </button>
        </td>
        ${tds}
      </tr>`;
        }
        // Nueva ronda (solo si el juego sigue)
        if (!isDisabled) {
          let tds = "";
          for (let j = 0; j < getPlayerCount(); j++) {
            tds += `<td class="px-2 py-2">
          <input type="number" min="0"
            value=""
            class="w-16 md:w-20 px-1 py-1 border rounded text-center opacity-60 bg-gray-100 focus:ring-2 focus:ring-blue-400 transition"
            placeholder="Nueva..."
            data-row="new" data-col="${j}"
            onkeydown="handleNewRowKey(event, ${j})"
            onclick="addRoundOnIntent(${j})"
            onfocus="addRoundOnIntent(${j}); handleInputFocusBlur();"
            onblur="handleInputBlur()"
          >
        </td>`;
          }
          tbody.innerHTML += `
        <tr onclick="addRoundOnIntent(0)">
          <td class="px-2 py-2 text-blue-400 text-xs cursor-pointer">+ nueva</td>
          ${tds}
        </tr>`;
        }
        setTimeout(() => {
          document.querySelectorAll(".fade-enter").forEach((row) => {
            row.classList.add("fade-enter-active");
          });
          if (focusNew) {
            const newRowIndex = roundsArr.length - 1; // El índice de la última ronda (la que se acaba de añadir)
            const inp = document.querySelector(
              `input[data-row='${newRowIndex}'][data-col='${focusCol}']`
            );
            if (inp) {
              inp.focus();
              inp.select();
            }
          }
          // Animación de enganche
          if (engancheAnimQueue.length) {
            engancheAnimQueue.forEach((i) => {
              let tds = document.querySelectorAll(`#totalRow td`);
              if (tds[i + 1]) {
                tds[i + 1].classList.add("enganchado-flash");
                setTimeout(
                  () => tds[i + 1].classList.remove("enganchado-flash"),
                  950
                );
              }
            });
            engancheAnimQueue = [];
          }
        }, 15);
        renderTotalRow();
        renderWinner();
      }

      function renderTotalRow() {
        const tfootRow = document.getElementById("totalRow");
        let totals = getTotals();
        tfootRow.innerHTML = `<td class="px-2 py-2 text-blue-900">Total</td>`;
        for (let i = 0; i < getPlayerCount(); i++) {
          let puedeEnganchar = shouldShowEnganchar(i);
          tfootRow.innerHTML += `<td class="px-2 py-2 text-blue-900 font-semibold ${
            isManualEnganchado(i) ? "enganchado" : ""
          }">
        <span>${totals[i]}</span>
        ${
          puedeEnganchar
            ? `<button onclick="handleEnganchar(${i})" class="ml-2 px-2 py-1 bg-yellow-500 text-white text-xs rounded animate-fadein">Enganchar</button>`
            : ""
        }
      </td>`;
        }
        updateAllTotals();
      }

      function renderWinner() {
        const winnerMsg = document.getElementById("winnerMsg");
        winnerMsg.classList.add("hidden");
        if (gameOver && winnerIndex !== null) {
          winnerMsg.classList.remove("hidden");
          winnerMsg.innerHTML = `<div class="winner-badge">🏆 Ganador: ${escapeHtml(
            playerNames[winnerIndex]
          )} (Pozo: $${calcularPozo()})</div>`;
        }
      }

      // --- UX ---
      let roundAddedInThisFocus = false;
      function addRoundOnIntent(col) {
        if (roundAddedInThisFocus) return;
        roundAddedInThisFocus = true;
        setTimeout(() => {
          roundAddedInThisFocus = false;
        }, 100);

        const newRoundIndex = roundsArr.length;
        roundsArr.push(Array(getPlayerCount()).fill(""));

        renderTable(true, col);
        showNotif("Ronda añadida", "bg-blue-600");
        saveToLS();
      }

      function handleNewRowKey(e, col) {
        if (e.key === "Tab" || e.key === "Enter") {
          e.preventDefault();
          addRoundOnIntent(col);
        }
      }

      function handleInput(rondaIdx, playerIdx, value) {
        roundsArr[rondaIdx][playerIdx] = value ? +value || 0 : "";
        checkGameEnd();
        updateTotal(playerIdx);
        renderTotalRow();
        if (getTotals()[playerIdx] > 100 && !shouldShowEnganchar(playerIdx)) {
          renderTable();
        }
        saveToLS();
      }

      function addPlayer() {
        if (gameOver) return;
        playerNames.push(`Jugador ${playerNames.length + 1}`);
        roundsArr.forEach((ronda) => ronda.push(""));
        renderHeader();
        renderTable();
        updateAllTotals();
        showNotif("Jugador añadido", "bg-blue-600");
        saveToLS();
      }

      function removePlayer(index) {
        if (getPlayerCount() <= 1) {
          showNotif("Debe haber al menos un jugador", "bg-red-700");
          return;
        }
        playerNames.splice(index, 1);
        manualEnganches = manualEnganches
          .filter((e) => e.idx !== index)
          .map((e) => ({ ...e, idx: e.idx > index ? e.idx - 1 : e.idx }));
        roundsArr.forEach((ronda) => ronda.splice(index, 1));
        renderHeader();
        renderTable();
        updateAllTotals();
        showNotif("Jugador eliminado", "bg-red-600");
        saveToLS();
      }
      function removeRound(idx) {
        if (roundsArr.length <= 1) {
          showNotif("Debe haber al menos una ronda", "bg-red-700");
          return;
        }
        roundsArr.splice(idx, 1);
        manualEnganches = manualEnganches
          .filter((e) => e.round !== idx)
          .map((e) => ({ ...e, round: e.round > idx ? e.round - 1 : e.round }));
        enganches = enganches
          .filter((e) => e.round !== idx)
          .map((e) => ({ ...e, round: e.round > idx ? e.round - 1 : e.round }));
        renderTable();
        showNotif("Ronda eliminada", "bg-red-600");
        saveToLS();
      }

      function updateTotal(playerIdx) {
        normalizeRoundsArr();
        const totals = getTotals();
        const el = document.querySelector(
          `#totalRow td:nth-child(${playerIdx + 2}) span`
        );
        if (el) el.textContent = totals[playerIdx];
        syncStickyTotals();
      }

      function updateAllTotals() {
        document.getElementById("pozoTotal").textContent =
          "Pozo: $" + calcularPozo();
        lastTotals = getTotals();
        syncStickyTotals();
        saveToLS();
      }

      function resetScores() {
        roundsArr.forEach((ronda) => {
          for (let i = 0; i < getPlayerCount(); i++) ronda[i] = "";
        });
        manualEnganches = [];
        gameOver = false;
        winnerIndex = null;
        enganches = [];
        renderHeader();
        renderTable();
        updateAllTotals();
        showNotif("Puntajes reiniciados", "bg-gray-600");
        saveToLS();
      }

      function editPlayerName(idx) {
        const th = document.querySelector(
          `#playerHeaders th:nth-child(${idx + 2})`
        );
        const prevName = playerNames[idx];
        th.innerHTML = `<input class="edit-input w-full px-1 py-1 rounded text-center border border-blue-400 ring-2 ring-blue-200 focus:ring-4 focus:ring-blue-400 transition text-gray-900"
    type="text"
    value="${prevName.replace(/"/g, "&quot;")}"
    onblur="savePlayerName(this, ${idx})"
    onkeydown="if(event.key==='Enter'){this.blur()}">`;
        th.querySelector("input").focus();
        th.querySelector("input").select();
      }

      function savePlayerName(input, idx) {
        let value = input.value.trim();
        if (!value) value = `Jugador ${idx + 1}`;
        playerNames[idx] = value;
        renderHeader();
        renderTable();
        updateAllTotals();
        showNotif("Nombre actualizado", "bg-green-700");
        saveToLS();
      }

      function getTotalsRaw() {
        return playerNames.map((_, i) =>
          roundsArr.reduce(
            (acc, ronda) => acc + (isFinite(ronda[i]) ? Number(ronda[i]) : 0),
            0
          )
        );
      }

      // ============= ENGANCHE Y GAME END ============
      function handleEnganchar(idx) {
        if (gameOver) return;
        const totalsAntesDelEnganche = getTotalsRaw();
        const vivos = getJugadoresVivos().filter((i) => i !== idx);

        if (vivos.length === 0) {
          showNotif("No hay jugadores a los que enganchar.", "bg-red-700");
          return;
        }

        const ref = vivos
          .map((i) => ({ i, t: totalsAntesDelEnganche[i] }))
          .sort((a, b) => b.t - a.t)[0].i;
        const refTotal = getTotals()[ref];

        let engancheRound = roundsArr.findIndex(
          (ronda, rIdx) =>
            (ronda[idx] === "" || ronda[idx] === undefined) &&
            rIdx < roundsArr.length - 1
        );

        let rondaParaRegistrarEnganche = -1;
        let hayRondasExistentesSinPuntajeParaEsteJugador = false;

        for (let r = 0; r < roundsArr.length; r++) {
          if (roundsArr[r][idx] === "" || roundsArr[r][idx] === undefined) {
            rondaParaRegistrarEnganche = r;
            hayRondasExistentesSinPuntajeParaEsteJugador = true;
            break;
          }
        }

        if (!hayRondasExistentesSinPuntajeParaEsteJugador) {
          rondaParaRegistrarEnganche = roundsArr.length;
          roundsArr.push(Array(getPlayerCount()).fill(""));
        }

        enganches.push({
          idx,
          round: rondaParaRegistrarEnganche,
          ref,
          total: isFinite(refTotal) ? refTotal : 0,
        });
        manualEnganches.push({
          idx,
          round: rondaParaRegistrarEnganche,
          ts: Date.now(),
        });
        engancheAnimQueue.push(idx);

        const indiceRondaSiguienteAlEnganche = rondaParaRegistrarEnganche + 1;
        if (indiceRondaSiguienteAlEnganche >= roundsArr.length) {
          roundsArr.push(Array(getPlayerCount()).fill(""));
        }
        renderTable();

        showNotif(
          `${escapeHtml(playerNames[idx])} enganchado al puntaje de ${escapeHtml(
            playerNames[ref]
          )}.`,
          "bg-yellow-600"
        );
        saveToLS();
      }
      // --- Ganador: siempre chequear si solo queda 1 jugador vivo
      function checkGameEnd() {
        const vivos = getJugadoresVivos();
        if (getPlayerCount() === 2) {
          let totals = getTotals();
          let loserIdx = null,
            winnerIdx_ = null;
          if (totals[0] >= 100 && totals[1] < 100) {
            loserIdx = 0;
            winnerIdx_ = 1;
          }
          if (totals[1] >= 100 && totals[0] < 100) {
            loserIdx = 1;
            winnerIdx_ = 0;
          }
          if (loserIdx !== null) {
            gameOver = true;
            winnerIndex = winnerIdx_;
            showNotif(
              `${escapeHtml(playerNames[winnerIdx_])} es el ganador!`,
              "bg-green-700"
            );
            renderTable();
            renderWinner();
            saveToLS();
          }
        } else if (vivos.length === 1 && !gameOver) {
          gameOver = true;
          winnerIndex = vivos[0];
          showNotif(
            `¡${escapeHtml(playerNames[winnerIndex])} es el ganador!`,
            "bg-green-700"
          );
          renderTable();
          renderWinner();
          saveToLS();
        }
      }

      function syncStickyTotals() {
        const stickyBar = document.getElementById("totalStickyBar");
        if (stickyBar && stickyBar.style.display !== "none") {
          const tfootRow = document.getElementById("totalRow");
          stickyBar.innerHTML =
            '<table class="min-w-max w-full border bg-white rounded-t shadow text-sm"><tfoot>' +
            tfootRow.outerHTML +
            "</tfoot></table>";
        }
      }

      // Sticky total (móvil)
      function enableStickyTotal(enable = true) {
        const totalRow = document.getElementById("totalRow");
        const stickyBar = document.getElementById("totalStickyBar");
        if (!stickyBar) return;

        if (enable) {
          stickyBar.style.display = "block";
          stickyBar.innerHTML =
            '<table class="min-w-max w-full border bg-white rounded-t shadow text-sm"><tfoot>' +
            totalRow.outerHTML +
            "</tfoot></table>";
          stickyBar.className =
            "sticky-total fixed left-0 right-0 bottom-0 z-50 w-full max-w-3xl mx-auto";
        } else {
          stickyBar.style.display = "none";
          stickyBar.innerHTML = "";
        }
      }

      function handleInputFocusBlur() {
        if (window.innerWidth <= 600) {
          enableStickyTotal(true);
          isStickyTotal = true;
        }
      }
      function handleInputBlur() {
        setTimeout(() => {
          if (
            !document.activeElement ||
            document.activeElement.tagName !== "INPUT"
          ) {
            enableStickyTotal(false);
            isStickyTotal = false;
          }
        }, 100);
      }
      window.addEventListener("resize", () => {
        if (isStickyTotal && window.innerWidth > 600) enableStickyTotal(false);
      });

      document.addEventListener("focusin", (e) => {
        if (e.target.tagName === "INPUT" && window.innerWidth < 800) {
          enableStickyTotal(true);
          // Oculta el tfoot original:
          document.querySelector("tfoot").style.visibility = "hidden";
        }
      });
      document.addEventListener("focusout", (e) => {
        if (e.target.tagName === "INPUT") {
          setTimeout(() => {
            if (
              !document.activeElement ||
              document.activeElement.tagName !== "INPUT"
            ) {
              enableStickyTotal(false);
              document.querySelector("tfoot").style.visibility = "";
            }
          }, 100);
        }
      });

      // Inicializar desde LS o default
      loadFromLS();
      renderHeader();
      renderTable();
    </script>
    <div id="totalStickyBar" style="display: none"></div>
  </body>
</html>
